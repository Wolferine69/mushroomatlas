{% extends 'messaging/messages_base.html' %}

{% block messages_content %}
<p><strong style="font-size: 1.5em;">Předmět:</strong> <span style="font-size: 1.5em;">{{ message.subject }}</span></p>
<p><strong>Od:</strong> {{ message.sender.username }}</p>
<p><strong>Datum:</strong> {{ message.timestamp }}</p>
<p>{{ message.content }}</p>

{% if message.attachments.exists %}
    <p><strong style="font-size: 1.5em;">Přílohy</strong></p>
<ul>
    {% for attachment in message.attachments.all %}
        <li><strong>Příloha:</strong> <a href="{{ attachment.file.url }}">{{ attachment.file.name }}</a></li>
    {% endfor %}
</ul>
{% endif %}

<div class="btn-group">
    {% if user_id %}
        <a href="{% url 'account_detail' user_id %}" class="btn btn-secondary">Zpět do detailu uživatele</a>
    {% elif origin == 'inbox' %}
        <a href="{% url 'view_inbox' %}" class="btn btn-secondary">Zpět do přijatých zpráv</a>
    {% elif origin == 'outbox' %}
        <a href="{% url 'view_outbox' %}" class="btn btn-secondary">Zpět do odeslaných zpráv</a>
    {% endif %}
    <a href="{% url 'reply_message' message.id %}" class="btn btn-primary">Odpovědět</a>
    <a href="{% url 'forward_message' message.id %}" class="btn btn-secondary">Přeposlat</a>
    {% if message.is_trashed_by_sender or message.is_trashed_by_receiver %}
        <a href="{% url 'restore_message' message.pk %}" class="btn btn-primary">Obnovit</a>
    {% endif %}
    <form id="delete-message-form" method="post" action="{% url 'delete_message' message.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="button" class="btn btn-danger" onclick="deleteMessage('{{ message.id }}')">Smazat</button>
    </form>
</div>

<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

function deleteMessage(messageId) {
    fetch(`/delete_message/${messageId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
        }
    }).then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Network response was not ok.');
    }).then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            console.error('Error:', data.error);
        }
    }).catch(error => {
        console.error('There was a problem with the fetch operation:', error);
    });
}
</script>
{% endblock %}
