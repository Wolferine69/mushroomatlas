{% extends 'messaging/messages_base.html' %}

{% block messages_content %}
<form method="get" action="">
    {{ form_sender.as_p }}
    <button type="submit" class="btn btn-primary">Filtrovat</button>
    <a href="{% url 'view_trash' %}" class="btn btn-secondary">Zrušit filtr</a>
</form>
<form id="trashForm" method="post" action="{% url 'handle_trash_actions' %}">
    {% csrf_token %}
    <ul>
        {% for message in trashed_messages %}
            <li>
                <input type="checkbox" name="message_ids" value="{{ message.id }}">
                <a href="{% url 'message_detail' message.id %}">
                    <strong>{{ message.timestamp }} - Od: {{ message.sender.username }} - Předmět: {{ message.subject }}</strong>
                </a>
                <p>{{ message.content|truncatewords:10 }}</p>
            </li>
        {% empty %}
            <li>Žádné zprávy v koši.</li>
        {% endfor %}
    </ul>
    <input type="hidden" name="action" id="action" value="">
    <button type="button" class="btn btn-danger" onclick="submitForm('delete')">Smazat vybrané</button>
    <button type="button" class="btn btn-success" onclick="submitForm('restore')">Obnovit vybrané</button>
</form>

<script type="text/javascript">
    function submitForm(action) {
        console.log("Setting action: " + action);
        document.getElementById('action').value = action;
        console.log("Form action set to: " + action);

        var checkboxes = document.querySelectorAll('input[name="message_ids"]:checked');
        console.log("Submitting form with message IDs:");
        checkboxes.forEach((checkbox) => {
            console.log(" - " + checkbox.value);
        });

        var form = document.getElementById('trashForm');
        if (form) {
            console.log("Form found, submitting...");
            form.submit();
        } else {
            console.log("Form not found!");
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log("Document loaded, adding event listeners...");
        document.querySelectorAll('button.btn-danger, button.btn-success').forEach(function(button) {
            button.addEventListener('click', function(event) {
                console.log("Button clicked:", event.target);
                submitForm(event.target.classList.contains('btn-danger') ? 'delete' : 'restore');
            });
        });
    });
</script>
{% endblock %}
